{% extends 'inventario/index.html'%} {% block contenido %} {% load static %}
<div class="row mt-3">
    <div class="col d-flex align-items-center justify-content-center">
        <div class="row d-flex justify-content-center">
            <h3 class="text-center">Entrada</h3>
        </div>
    </div>
</div>
<hr>

<div class="row justify-content-center mx-2">

    <div class="col">
        <div class="form-floating ">
            <select name="proveedor" id="proveedor" class="form-select">
                <option value="">Selecciona un proveedor</option>
                {% for proveedor in proveedores %}
                <option value="{{ proveedor.id }}">{{ proveedor.nombre_empresa}}</option>
                {% endfor %}
            </select>
            <label for="proveedor" class="form-label">Proveedor:</label>
        </div>
        <div class="d-flex justify-content-center mt-2 mb-2">
            <a class="btn buttons fw-bold" href="{% url 'proveedores' %}"><i class="fa-solid fa-circle-plus"></i>
                Agregar Proveedor
            </a>
        </div>
    </div>

    <div class="col">
        <div class="form-floating">
            <select name="product_name" id="product_name" class="form-select">
                <option value="">Selecciona un producto</option>
            </select>
            <label for="product_name" class="form-label">Producto:</label>
        </div>
        <div class="d-flex justify-content-center mt-2 mb-2">
            <a class="btn buttons fw-bold" href="{% url 'productos' %}"><i class="fa-solid fa-circle-plus"></i>
                Agregar Productos
            </a>
        </div>
    </div>
</div>

<div class="row mx-2">
    <div class="col">
        <div id="precio-div">
            <div class="form-floating">
                <input type="number" id="precio" name="precio" placeholder="Precio" class="form-control">
                <label for="precio" class="form-label">Precio unitario:</label>
            </div>
        </div>
    </div>
    <div class="col">
        <div id="cantidad-div">
            <div class="form-floating">
                <input type="number" id="cantidad" name="cantidad" placeholder="cantidad" class="form-control">
                <label for="cantidad" class="form-label">cantidad:</label>
            </div>
        </div>
    </div>
</div>

<div class="row mx-2">
    <div class="col d-flex justify-content-center mt-3">
        <button id="crear-entrada" type="button" class="btn buttons mx-1 mt-3 fw-bold">Crear entrada</button>
    </div>
</div>
<hr>
<script>
    $('#crear-entrada').click(function () {
        var proveedor = $('#proveedor').val();
        var product_name = $('#product_name').val();
        var precio = $('#precio').val();
        var cantidad = $('#cantidad').val();
    
        // Crea un objeto con los datos
        var data = {
            proveedor: proveedor,
            detalles: [
                {
                    producto: product_name,
                    cantidad: cantidad,
                    precio_unitario: precio
                }
            ]
        };
        axios.defaults.xsrfCookieName = 'csrftoken'; // Nombre de la cookie CSRF
        axios.defaults.xsrfHeaderName = 'X-CSRFToken'; // Nombre del encabezado CSRF
    
        // Realiza una solicitud POST a la API de creación de compra utilizando Axios
        axios.post("{% url 'crear_compra_api' %}", data, {
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(response => {
                // Maneja la respuesta de la API, por ejemplo, muestra un mensaje de éxito o error
                console.log(response.data);
            })
            .catch(error => {
                console.error(error);
            });
    });
    
    
    $('#proveedor').change(async function () {
        var proveedorSeleccionado = $(this).val();
        if (proveedorSeleccionado) {
            axios.defaults.xsrfCookieName = 'csrftoken';
            axios.defaults.xsrfHeaderName = 'X-CSRFToken';
            try {
                const response = await axios.post("/productos_por_proveedor/" + proveedorSeleccionado + "/");
                console.log(response.data);
    
                var productSelect = $('#product_name');
                productSelect.empty();
    
                if (response.data.length > 0) {
                    response.data.forEach(product => {
                        productSelect.append($('<option>', {
                            value: product.id,
                            text: product.nombre
                        }));
                    });
                } else {
                    // No se encontraron productos, muestra un mensaje en el select.
                    productSelect.append($('<option>', {
                        value: '',
                        text: 'No hay productos disponibles para este proveedor'
                    }));
                }
            } catch (error) {
                console.error(error);
            }
        } else {
            // Si no se ha seleccionado un proveedor, limpia y deshabilita el select de productos.
            var productSelect = $('#product_name');
            productSelect.empty().append($('<option>', {
                value: '',
                text: 'Selecciona un producto'
            }));
        }
    });
</script>
{% endblock %}